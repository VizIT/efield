/*
 Copyright 2013 VizIT Solutions

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/
function motionEventHandler(a){var d,b,c,e;d=[];b=!1;e=c=null;this.findTouchByIdentifier=function(a){var c,e;for(c=0;c<d.length;c++)if(e=d[c].identifier,e==a)return c;return-1};this.handleTouchStart=function(a){var c,e,b;b=a.targetTouches;for(c=0;c<b.length;c++)e=b[c],-1==this.findTouchByIdentifier(e.identifier)&&d.push(e);if(a.preventDefault)a.preventDefault();else return!1};this.handleTouchEnd=function(a){var c,e,b;b=a.changedTouches;for(c=0;c<b.length;c++)e=this.findTouchByIdentifier(b[c].identifier),
-1!=e&&d.splice(e,1);if(a.preventDefault)a.preventDefault();else return!1};this.handleOneActiveMove=function(c){var e,b,g,l;l=c.changedTouches[0];b=d[0];null!=b?(e=l.pageX-b.pageX,b=l.pageY-b.pageY,g=a.getModelViewMatrix(),rotateXY(g,b/150,e/150),a.setModelViewMatrix(g),a.render(),d.splice(0,1,l)):d.push(l);if(c.preventDefault)c.preventDefault();else return!1};this.handleTwoActiveMove=function(c){var e,b,g,l,p,m,n,B;m=d[0];g=d[1];e=g.pageX-m.pageX;b=g.pageY-m.pageY;p=Math.sqrt(e*e+b*b);l=Math.atan2(b,
e);B=c.changedTouches;for(e=0;e<B.length;e++)n=B[e],b=n.identifier,m.identifier==b?(m=n,d.splice(0,1,n)):g.identifier==b&&(g=n,d.splice(1,1,n));e=g.pageX-m.pageX;b=g.pageY-m.pageY;m=Math.sqrt(e*e+b*b);l-=Math.atan2(b,e);g=a.getModelViewMatrix();rotateZ(g,l);a.setModelViewMatrix(g);a.zoomBy(-(m-p)/4);if(c.preventDefault)c.preventDefault();else return!1};this.handleTouchMove=function(a){return 1==d.length?this.handleOneActiveMove(a):2==d.length?this.handleTwoActiveMove(a):!0};this.handleMouseDown=function(a){b=
!0;c=a.clientX;e=a.clientY};this.handleMouseUp=function(a){b=!1};this.handleMouseMove=function(f){if(b){var h,d=f.clientX,g=f.clientY,l=d-c,p=g-e;h=a.getModelViewMatrix();f.shiftKey?rotateZ(h,(p+l)/30):rotateXY(h,p/30,l/30);a.setModelViewMatrix(h);a.render();c=d;e=g}};this.handleMouseWheel=function(c){c=window.event||c;a.zoomBy(c.wheelDeltaY/8);if(c.preventDefault)c.preventDefault();else return!1}};function GLContextEventHandler(a,d){var b,c;this.contextLost=function(a){a.preventDefault()};this.contextRestored=function(a){c.initializeContext(b);latch=new countdownLatch(2,c.initialRender.bind(c))};b=a;c=d};function getGLContext(a){if(a=a.getContext("webgl",{antialias:!0})||a.getContext("experimental-webgl",{antialias:!0}))a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS);return a}function compileShader(a,d,b){b=a.createShader(b);a.shaderSource(b,d);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS)&&!a.isContextLost())throw"Shader compile failed with:"+a.getShaderInfoLog(b);return b}
function createProgram(a,d,b){var c=a.createProgram();a.attachShader(c,d);a.attachShader(c,b);a.linkProgram(c);return c}function createBuffer(a,d){var b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);return b}function createIndexBuffer(a,d){var b=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b);a.bufferData(a.ELEMENT_ARRAY_BUFFER,d,a.STATIC_DRAW);return b}
function bindBuffer(a,d,b,c,e,f,h,k){a.bindBuffer(a.ARRAY_BUFFER,d);d=a.getAttribLocation(c,b);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,e,f,!1,h,k)}function loadTexture(a,d,b,c){var e=a.createTexture(),f=new Image;f.onload=function(){onTextureLoaded(a,f,e,b,c)};f.src=d;return e}
function onTextureLoaded(a,d,b,c,e){a.activeTexture(a.TEXTURE0+c);a.bindTexture(a.TEXTURE_2D,b);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_NEAREST);a.generateMipmap(a.TEXTURE_2D);e()}function bindTexture(a,d,b,c,e){a.activeTexture(a.TEXTURE0+c);a.bindTexture(a.TEXTURE_2D,b);d=a.getUniformLocation(d,e);a.uniform1i(d,c)}
function generateModelViewMatrix(a){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,a,0,0,1])}function generatePerspectiveMatrix(a,d,b,c){return new Float32Array([b/a,0,0,0,0,b/d,0,0,0,0,-(c+b)/(c-b),-1,0,0,-2*c*b/(c-b),0])}function generateOrthographicMatrix(a,d,b,c){return new Float32Array([1/a,0,0,0,0,1/d,0,0,0,0,-2/(c-b),0,0,0,-(c+b)/(c-b),1])}function loadUniform3f(a,d,b,c,e,f){d=a.getUniformLocation(d,b);-1==d?alert("Can not find uniform"+b+"."):a.uniform3f(d,c,e,f)}
function loadUniform4f(a,d,b,c,e,f,h){d=a.getUniformLocation(d,b);-1==d?alert("Can not find uniform"+b+"."):a.uniform4f(d,c,e,f,h)}function loadUniformMatrix3fv(a,d,b,c){d=a.getUniformLocation(d,b);-1==d?alert("Can not find uniform"+b+"."):a.uniformMatrix3fv(d,!1,c)}function loadUniformMatrix4fv(a,d,b,c){d=a.getUniformLocation(d,b);-1==d?alert("Can not find uniform"+b+"."):a.uniformMatrix4fv(d,!1,c)}function countdownLatch(a,d){var b=a;this.countDown=function(){b--;0>=b&&d()}}
function getXYRotationMatrix(a,d){Math.cos(a);Math.cos(d);Math.sin(a);Math.sin(d)}function rotateXY(a,d,b){var c,e,f=Math.cos(d),h=Math.cos(b);d=Math.sin(d);var k=Math.sin(b),g=d*k,l=h*d,p=f*k,m=f*h;b=a[0];c=a[1];e=a[2];a[0]=b*h+e*k;a[1]=b*g+c*f-e*l;a[2]=-b*p+c*d+e*m;b=a[4];c=a[5];e=a[6];a[4]=b*h+e*k;a[5]=b*g+c*f-e*l;a[6]=-b*p+c*d+e*m;b=a[8];c=a[9];e=a[10];a[8]=b*h+e*k;a[9]=b*g+c*f-e*l;a[10]=-b*p+c*d+e*m;b=a[12];c=a[13];e=a[14];a[12]=b*h+e*k;a[13]=b*g+c*f-e*l;a[14]=-b*p+c*d+e*m;return a}
function rotateZ(a,d){var b,c,e,f;e=Math.cos(d);f=Math.sin(d);b=a[0];c=a[1];a[0]=b*e-c*f;a[1]=b*f+c*e;b=a[4];c=a[5];a[4]=b*e-c*f;a[5]=b*f+c*e;b=a[8];c=a[9];a[8]=b*e-c*f;a[9]=b*f+c*e;b=a[12];c=a[13];a[12]=b*e-c*f;a[13]=b*f+c*e;return a}function extractRotationPart(a,d){d.set(a.subarray(0,3));d.set(a.subarray(4,7),3);d.set(a.subarray(8,11),6);return d}
function Color(a,d,b,c){var e,f,h,k;this.setRed=function(a){e=a;return this};this.getRed=function(){return e};this.setGreen=function(a){f=a;return this};this.getGreen=function(){return f};this.setBlue=function(a){h=a;return this};this.getBlue=function(){return h};this.setAlpha=function(a){k=a;return this};this.getAlpha=function(){return k};this.setRed(a).setGreen(d).setBlue(b).setAlpha(c)};function surfaceGeometry(a,d){var b,c,e,f,h;c=d;f=a;h=new Float32Array(3*a);b=new Uint16Array(d);e=new Float32Array(3*a);this.setNindices=function(a){c=a};this.getNindices=function(){return c};this.setNvertices=function(a){f=a};this.getNvertices=function(){return f};this.setVerticies=function(a){h=a};this.getVertices=function(){return h};this.setIndices=function(a){};this.getIndices=function(){return b};this.setNormals=function(a){};this.getNormals=function(){return e}}
function GeometryEngine(){}GeometryEngine.Sides={TOP:{value:"top"},BOTTOM:{value:"bottom"},LEFT:{value:"left"},RIGHT:{value:"right"}};GeometryEngine.Shapes={SPHERE:{value:"sphere"},SQUARE:{value:"square"},CYLINDER:{value:"cylinder"}};GeometryEngine.VertexRegistry=function(){var a;a={};this.registerVertices=function(d,b){if(a.hasOwnProperty(d))throw"Vertex buffers already registered for "+d+".";a[d]=b};this.hasVertices=function(d){return a.hasOwnProperty(d)};this.retrieveVertices=function(d){return a[d]}};
GeometryEngine.square=function(){var a,d,b;b=GeometryEngine.Shapes.SQUARE;a=[-0.5,0.5,0,0.5,0.5,0,0.5,-0.5,0,-0.5,-0.5,0];d=[0,0,1];this.getNindices=function(){return 6};this.computeGeometry=function(a,e){var b,h,k;k=a.getVertices();h=a.getNormals();b=a.getIndices();for(var g=0;12>g;g++)k[g]=e[g],h[g]=d[g%3];b[0]=0;b[1]=3;b[2]=1;b[3]=3;b[4]=2;b[5]=1;a.setNvertices(12);a.setNindices(6)};this.getVertexBuffers=function(c,e){var f,h;e.hasVertices(b.value)?h=e.retrieveVertices(b.value):(f=new surfaceGeometry(4,
6),h={},this.computeGeometry(f,a),h.vertices=createBuffer(c,f.getVertices()),h.normals=createBuffer(c,f.getNormals()),h.indices=createIndexBuffer(c,f.getIndices()),e.registerVertices(b.value,h));return h}};
GeometryEngine.cylinder=function(){var a;a=GeometryEngine.Shapes.CYLINDER;this.getBaseHeight=function(){return 1};this.getBaseRadius=function(){return 1};this.getShape=function(){return a};this.getNindices=function(){return 126};this.computeGeometry=function(a){var b,c,e,f,h,k,g;g=a.getVertices();f=a.getNormals();e=a.getIndices();g[0]=0;f[0]=0;g[1]=0;f[1]=0;g[2]=0.5;f[2]=1;e[0]=0;b=94;e[b]=b;b*=3;g[b]=0;f[b++]=0;g[b]=0;f[b++]=0;g[b]=-0.5;f[b]=-1;for(c=1;31>=c;c++)b=2*(c-1)*Math.PI/30,e[c]=c,k=3*c,
g[k]=1*Math.cos(b),f[k++]=0,g[k]=1*Math.sin(b),f[k++]=0,g[k]=0.5,f[k]=1;for(c=1;31>=c;c++)k=3*c,b=c+90+4,e[b]=b,b*=3,g[b]=g[k++],f[b++]=0,g[b]=g[k],f[b++]=0,g[b]=-0.5,f[b]=-1;k=3;b=285;h=96;for(c=0;30>=c;c++)e[h/3]=h/3,g[h]=g[k],f[h++]=g[k++]/1,g[h]=g[k],f[h++]=g[k++]/1,g[h]=g[k],f[h++]=g[k++]/1,e[h/3]=h/3,g[h]=g[b],f[h++]=g[b++]/1,g[h]=g[b],f[h++]=g[b++]/1,g[h]=g[b],f[h++]=g[b++]/1;a.setNvertices(378);a.setNindices(126)};this.getVertexBuffers=function(d,b){var c,e;b.hasVertices(a.value)?e=b.retrieveVertices(a.value):
(c=new surfaceGeometry(126,126),e={},this.computeGeometry(c),e.vertices=createBuffer(d,c.getVertices()),e.normals=createBuffer(d,c.getNormals()),e.indices=createIndexBuffer(d,c.getIndices()),b.registerVertices(a.value,e));return e}};
GeometryEngine.sphere=function(){var a;a=GeometryEngine.Shapes.SPHERE;this.getIntrinsicRadius=function(){return 30};this.getShape=function(){return a};this.getNindices=function(){return 5400};this.computeGeometry=function(a,b,c,e){var f,h,k,g,l,p,m,n,B,q,t;q=a.getVertices();m=p=0;k=a.getNormals();for(g=0;g<=c;g++)for(l=g*Math.PI/c,B=Math.sin(l),h=Math.cos(l),l=0;l<=e;l++)f=2*l*Math.PI/e,n=Math.sin(f),f=Math.cos(f),n*=B,t=h,f*=B,k[m]=n,q[m++]=b*n,k[m]=t,q[m++]=b*t,k[m]=f,q[m++]=b*f;a.setNvertices(--m);
k=a.getIndices();for(g=0;g<c;g++)for(l=0;l<e;l++)b=g*(e+1)+l,m=b+e+1,k[p++]=b,k[p++]=m,k[p++]=b+1,k[p++]=m,k[p++]=m+1,k[p++]=b+1;a.setNindices(--p)};this.getVertexBuffers=function(d,b){var c,e;b.hasVertices(a.value)?e=b.retrieveVertices(a.value):(c=new surfaceGeometry(961,5400),e={},this.computeGeometry(c,30,30,30),e.vertices=createBuffer(d,c.getVertices()),e.normals=createBuffer(d,c.getNormals()),e.indices=createIndexBuffer(d,c.getIndices()),b.registerVertices(a.value,e));return e}};function Charge(a,d,b,c){var e=[d,b,c];this.getCharge=function(){return a};this.setPosition=function(a){this.position=a};this.getPosition=function(){return e};this.getField=function(c,b,d){var g,l=[0,0,0],p;c-=e[0];b-=e[1];d-=e[2];g=c*c+b*b+d*d;if(0>=g)return l;p=Math.sqrt(g);g=a/g;l[0]=g*c/p;l[1]=g*b/p;l[2]=g*d/p;return l};this.getFieldSeedPointsI=function(c){var b,d,g,l,p,m;l=[];p=0<a?1:0>a?-1:0;c=Math.round(c*a*p);b=2/c;for(var n=0;n<c;n++)m=n*b-1+b/2,g=Math.sqrt(1-m*m),d=2.39996323*n,l.push([Math.cos(d)*
g+e[0],m+e[1],Math.sin(d)*g+e[2],p]);return l};this.getStartPoints=function(c){var b,d,g,l,p,m;p=0<a?1:0>a?-1:0;c=Math.round(c*a*p);g=3.6/Math.sqrt(c);b=Math.random()*Math.PI/2;l=[];l.push([0,-1,0,p]);for(var n=1;n<c;n++)m=-1+2*n/(c-1),d=Math.sqrt(1-m*m),b+=g/d,l.push([Math.cos(b)*d+e[0],m+e[1],Math.sin(b)*d+e[2],p]);l.push([0,1,0,p]);return l}}
function Charges(){var a=[],d=[];this.addCharge=function(b){a.push(b);return this};this.getCharges=function(){return a};this.getNCharges=function(){return a.length};this.addDistribution=function(a){d.push(a);return this};this.getDistributions=function(){return d};this.getNDistributions=function(){return d.length};this.getField=function(b,c,e){var f=[0,0,0],f=this.getFieldFromCharges(a,b,c,e);b=this.getFieldFromCharges(d,b,c,e);f[0]+=b[0];f[1]+=b[1];f[2]+=b[2];return f};this.getFieldFromCharges=function(a,
c,e,f){for(var d,k=[0,0,0],g=0,l=a.length;g<l;g++)d=a[g],d=d.getField(c,e,f),k[0]+=d[0],k[1]+=d[1],k[2]+=d[2];return k};this.setVertexRegistry=function(a){for(var c=0,e=d.length;c<e;c++)d[c].setVertexRegistry(a)}}
function fluxLine(a){var d,b,c,e,f=0,h,k,g,l,p,m,n;this.getArrows=function(){return c};this.setMaxPoints=function(a){a!=f&&(f=a,g=new Float32Array(3*f),c=new Float32Array(f));return this};this.getMaxPoints=function(){return f};this.setArrowSize=function(a){d=a;return this};this.getArrowSize=function(){return d};this.setArrowSpacing=function(a){b=a;return this};this.getArrowSpacing=function(){return b};this.getNarrows=function(){return k};this.getNpoints=function(){return h};this.getPoints=function(){return g};
this.setDs=function(a){e=a;return this};this.getDs=function(){return e};this.setSign=function(a){l=a;return this};this.getSign=function(){return l};this.setStartX=function(a){p=a;return this};this.getStartX=function(){return p};this.setStartY=function(a){m=a;return this};this.getStartY=function(){return m};this.setStartZ=function(a){n=a;return this};this.getStartZ=function(){return n};this.drawArrow=function(a,b,e,f,d,g,h){var p,k,m,l,n;p=f[0]/d;k=f[1]/d;m=f[2]/d;0!=m?(l=d=1,f=-(f[0]+f[1])/f[2]):
(0!=k?(d=1,l=-(f[0]+f[2])/f[1]):(d=-(f[1]+f[2])/f[0],l=1),f=1);n=g/Math.sqrt(d*d+l*l+f*f);d*=n;l*=n;f*=n;p*=g;k*=g;g*=m;h*=12;c[h]=a-p+d;c[h+1]=b-k+l;c[h+2]=e-g+f;c[h+3]=a;c[h+4]=b;c[h+5]=e;c[h+6]=a;c[h+7]=b;c[h+8]=e;c[h+9]=a-p-d;c[h+10]=b-k-l;c[h+11]=e-g-f};this.trace=function(){var c,q,t,u,y,A,v;k=c=0;y=p;A=m;v=n;for(u=0;u<f;u++){q=3*u;g[q]=y;g[q+1]=A;g[q+2]=v;t=a.getField(y,A,v);q=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);if(0==q)break;y+=l*t[0]/q*e;A+=l*t[1]/q*e;v+=l*t[2]/q*e;c+=e;c>b&&(c=0,this.drawArrow(y,
A,v,t,q,d,k),k++)}h=u}};function gaussianSphere(a,d,b,c){var e,f,h,k,g,l;f=c;k=a;g=d;l=b;this.setVertexRegistry=function(a){h=a};this.getVertexRegistry=function(){return h};this.setX=function(a){k=a;return this};this.getX=function(){return k};this.setY=function(a){g=a;return this};this.getY=function(){return g};this.setZ=function(a){l=a;return this};this.getZ=function(){return l};this.setRadius=function(a){f=a;return this};this.getRadius=function(){return f};this.getModelView=function(a){"undefined"===typeof a&&(a=1);null==
e?(e=new Float32Array(16),e[0]=a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=a,e[11]=0,e[12]=k,e[13]=g,e[14]=l,e[15]=1):(e[0]=a,e[5]=a,e[10]=a);return e};this.drawFullSurface=function(a,c,b,e,f,d){bindBuffer(a,b,"position",c,3,a.FLOAT,0,0);bindBuffer(a,e,"normal",c,3,a.FLOAT,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.drawElements(a.TRIANGLES,d,a.UNSIGNED_SHORT,0)};this.render=function(a,c){var b,e;b=this.getIntrinsicRadius();e=this.getVertexBuffers(a,h);loadUniformMatrix4fv(a,
c,"modelViewMatrix",this.getModelView(f/b));a.cullFace(a.FRONT);this.drawFullSurface(a,c,e.vertices,e.normals,e.indices,this.getNindices());a.cullFace(a.BACK);this.drawFullSurface(a,c,e.vertices,e.normals,e.indices,this.getNindices())}}gaussianSphere.prototype=new GeometryEngine.sphere;function cylinder(){var a,d,b;this.setVertexRegistry=function(a){b=a};this.getVertexRegistry=function(){return b};this.setColor=function(a){d=a};this.getColor=function(){return d};this.getCylinderModelView=function(a,e,b,d,k,g,l){var p,m,n;n=Math.sin(l);l=Math.cos(l);m=Math.sin(g);g=Math.cos(g);p=new Float32Array(16);p[0]=k*g*l;p[1]=k*l*m;p[2]=-k*n;p[3]=0;p[4]=-k*m;p[5]=k*g;p[6]=0;p[7]=0;p[8]=d*g*n;p[9]=d*m*n;p[10]=d*l;p[11]=0;p[12]=a;p[13]=e;p[14]=b;p[15]=1;return p};this.transformPoints=function(c,
b,f,d){var k,g,l;a[0]=c[0]*f;a[1]=c[1]*f;a[2]=c[2]*f;a[3]=c[3];a[4]=c[4]*f;a[5]=c[5]*f;a[6]=c[6]*f;a[7]=c[7];a[8]=c[8]*b;a[9]=c[9]*b;a[10]=c[10]*b;a[11]=c[11];a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15];b=0;for(c=d.length;b<c;b++)f=d[b],k=f[0],g=f[1],l=f[2],f[0]=a[0]*k+a[4]*g+a[8]*l+a[12],f[1]=a[1]*k+a[5]*g+a[9]*l+a[13],f[2]=a[2]*k+a[6]*g+a[10]*l+a[14];return d};this.setupBuffers=function(a,b,f,d,k){bindBuffer(a,f,"position",b,3,a.FLOAT,0,0);bindBuffer(a,d,"normal",b,3,a.FLOAT,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
k)};this.drawCap=function(a,b,f){a.drawElements(a.TRIANGLE_FAN,b,a.UNSIGNED_SHORT,2*f)};this.drawSide=function(a,b,f){a.drawElements(a.TRIANGLE_STRIP,b,a.UNSIGNED_SHORT,2*f)};this.drawCylinder=function(a,b,f,d,k){loadUniformMatrix4fv(a,b,"modelViewMatrix",f);k&&this.drawCap(a,d+2,0);this.drawSide(a,2*d+2,d+2);k&&this.drawCap(a,d+2,3*d+4)};this.fullRender=function(c,e,f,h,k,g,l){var p,m,n;m=this.getBaseRadius();n=this.getVertexBuffers(c,b);loadUniform4f(c,e,"surfaceColor",d.getRed(),d.getGreen(),d.getBlue(),
d.getAlpha());p=(this.getNindices()-6)/4;this.setupBuffers(c,e,n.vertices,n.normals,n.indices);a[3]=f[3];a[7]=f[7];a[8]=f[8]*h;a[9]=f[9]*h;a[10]=f[10]*h;a[11]=f[11];a[12]=f[12];a[13]=f[13];a[14]=f[14];a[15]=f[15];c.cullFace(c.FRONT);for(h=g;h>=k;h--)n=h/m,a[0]=f[0]*n,a[1]=f[1]*n,a[2]=f[2]*n,a[4]=f[4]*n,a[5]=f[5]*n,a[6]=f[6]*n,this.drawCylinder(c,e,a,p,l);c.cullFace(c.BACK);for(h=k;h<=g;h++)n=h/m,a[0]=f[0]*n,a[1]=f[1]*n,a[2]=f[2]*n,a[4]=f[4]*n,a[5]=f[5]*n,a[6]=f[6]*n,this.drawCylinder(c,e,a,p,l)};
this.translateBounds=function(a,b,d,h,k,g,l){var p,m,n;p=(b+k)/2;m=(d+g)/2;n=(h+l)/2;b-=p;d-=m;h-=n;k-=p;g-=m;l-=n;a.setTx(p).setTy(m).setTz(n).setX0(b).setY0(d).setZ0(h).setX1(k).setY1(g).setZ1(l)};this.sign=function(a){return 0>a?-1:1};this.zAxisRotation=function(a,b,d,h,k){var g;g=Math.atan2(k-d,h-b);b=-this.sign(h)*Math.sqrt(b*b+d*d);d=0;h=-b;k=0;a.setX0(b).setY0(d).setX1(h).setY1(k).setPhi(g)};this.yAxisRotation=function(a,b,d,h,k,g,l){d=Math.sqrt(b*b+d*d+h*h);g=Math.acos(l/d);h=this.sign(l);
l=h*d;k=b=0;a.setZ0(-h*d).setZ1(l).setX0(b).setX1(k).setTheta(g)};this.scale=function(a,b,d){var h;h=this.sign(d);b=d-b;a.setZ0(0.5*-h).setZ1(0.5*h).setHeight(b)};a=new Float32Array(16)}cylinder.prototype=new GeometryEngine.cylinder;function chargedLine(a,d,b,c,e,f,h,k){var g,l,p,m,n,B,q,t,u,y,A,v,w,s,x,D,r,z,C,E,F;this.setHeight=function(a){g=a};this.getHeight=function(){return g};this.setTx=function(a){u=a;return this};this.getTx=function(){return u};this.setTy=function(a){y=a;return this};this.getTy=function(){return y};this.setTz=function(a){A=a;return this};this.getTz=function(){return A};this.setX0=function(a){v=a;return this};this.getX0=function(){return v};this.setY0=function(a){w=a;return this};this.getY0=function(){return w};
this.setZ0=function(a){s=a;return this};this.getZ0=function(){return s};this.setX1=function(a){x=a;return this};this.getX1=function(){return x};this.setY1=function(a){D=a;return this};this.getY1=function(){return D};this.setZ1=function(a){r=a;return this};this.getZ1=function(){return r};this.setR0=function(a){q=a;return this};this.getR0=function(){return q};this.setR1=function(a){t=a;return this};this.getR1=function(){return t};this.setPhi=function(a){m=a;return this};this.getPhi=function(){return m};
this.setTheta=function(a){n=a;return this};this.getStartPoints=function(){var a,b,c,d,e;e=[];if(0!=B){d=this.sign(l);b=Math.max(2,Math.round(Math.abs(l*B*g)));c=-0.5;a=1/(b-1);for(var f=0;f<b;f++)e.push([1,0,c,d]),e.push([-1,0,c,d]),e.push([0,1,c,d]),e.push([0,-1,c,d]),e.push([0.707106781,0.707106781,c,d]),e.push([0.707106781,-0.707106781,c,d]),e.push([-0.707106781,-0.707106781,c,d]),e.push([-0.707106781,0.707106781,c,d]),c+=a}return this.transformPoints(p,g/this.getBaseHeight(),(q+1)/this.getBaseRadius(),
e)};this.getNormal=function(a,b,c){var d,e,f,g;d={};e=-((v-a)*z+(w-b)*C+(s-c)*E)/(F*F);f=v+e*z;g=w+e*C;e=s+e*E;d.x=a-f;d.y=b-g;d.z=c-e;return d};this.getField=function(a,b,c){var d;c=this.getNormal(a,b,c);d=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z);a=Array(3);b=2*l/d;a[0]=b*c.x/d;a[1]=b*c.y/d;a[2]=b*c.z/d;return a};this.render=function(a,b){this.fullRender(a,b,p,g,q,t,!1)};l=h;h=0<l?new Color(0.05,0.05,0.8,0.8):0>l?new Color(0.8,0.05,0.05,0.8):new Color(0.5,0.5,0.5,0.8);this.setColor(h);q=0;t=3;B=k;v=a;
w=d;s=b;x=c;D=e;r=f;this.translateBounds(this,v,w,s,x,D,r);this.zAxisRotation(this,v,w,x,D);this.yAxisRotation(this,v,w,s,x,D,r);this.scale(this,s,r);v=a;w=d;s=b;x=c;D=e;r=f;p=this.getCylinderModelView(u,y,A,this.getBaseHeight(),this.getBaseRadius(),m,n);z=x-v;C=D-w;E=r-s;F=Math.sqrt(z*z+C*C+E*E)}chargedLine.prototype=new cylinder;function chargedCylinder(a,d,b,c,e,f,h,k,g,l){var p,m,n,B,q,t,u,y,A,v,w,s,x,D,r,z,C,E,F,G,H;this.setHeight=function(a){p=a};this.getHeight=function(){return p};this.setTx=function(a){A=a;return this};this.getTx=function(){return A};this.setTy=function(a){v=a;return this};this.getTy=function(){return v};this.setTz=function(a){w=a;return this};this.getTz=function(){return w};this.setX0=function(a){s=a;return this};this.getX0=function(){return s};this.setY0=function(a){x=a;return this};this.getY0=function(){return x};
this.setZ0=function(a){D=a;return this};this.getZ0=function(){return D};this.setX1=function(a){r=a;return this};this.getX1=function(){return r};this.setY1=function(a){z=a;return this};this.getY1=function(){return z};this.setZ1=function(a){C=a;return this};this.getZ1=function(){return C};this.setR0=function(a){u=a;return this};this.getR0=function(){return u};this.setR1=function(a){y=a;return this};this.getR1=function(){return y};this.setPhi=function(a){n=a;return this};this.getPhi=function(){return n};
this.setTheta=function(a){B=a;return this};this.getStartPoints=function(){var a,b,c,d,e,f,g;g=[];if(0!=t){f=this.sign(q);b=Math.max(2,Math.round(Math.abs(q*Math.PI*(y*y-u*u)*t*p)));c=(u+1)/y;d=0.707106781*(u+1)/y;e=-0.5;a=1/(b-1);for(var h=0;h<b;h++)g.push([c,0,e,f]),g.push([-c,0,e,f]),g.push([0,c,e,f]),g.push([0,-c,e,f]),g.push([d,d,e,f]),g.push([d,-d,e,f]),g.push([-d,-d,e,f]),g.push([-d,d,e,f]),e+=a}return this.transformPoints(m,p/this.getBaseHeight(),y/this.getBaseRadius(),g)};this.getNormal=function(a,
b,c){var d,e,f,g;d={};e=-((s-a)*E+(x-b)*F+(D-c)*G)/(H*H);f=s+e*E;g=x+e*F;e=D+e*G;d.x=a-f;d.y=b-g;d.z=c-e;return d};this.getField=function(a,b,c){var d;d=Array(3);b=this.getNormal(a,b,c);c=Math.sqrt(b.x*b.x+b.y*b.y+b.z*b.z);a=2*(c<u?0:c<y?Math.PI*(c*c-u*u)*q:Math.PI*(y*y-u*u)*q)/c;d[0]=a*b.x/c;d[1]=a*b.y/c;d[2]=a*b.z/c;return d};this.render=function(a,b){this.fullRender(a,b,m,p/this.getBaseHeight(),u/this.getBaseRadius(),y/this.getBaseRadius(),!1)};u=h;y=k;q=g;t=l;s=a;x=d;D=b;r=c;z=e;C=f;h=0<q?new Color(0.05,
0.05,0.8,0.3):0>q?new Color(0.8,0.05,0.05,0.3):new Color(0.5,0.5,0.5,0.2);this.setColor(h);this.translateBounds(this,s,x,D,r,z,C);this.zAxisRotation(this,s,x,r,z);this.yAxisRotation(this,s,x,D,r,z,C);this.scale(this,D,C);s=a;x=d;D=b;r=c;z=e;C=f;m=this.getCylinderModelView(A,v,w,this.getBaseHeight(),this.getBaseRadius(),n,B);E=r-s;F=z-x;G=C-D;H=Math.sqrt(E*E+F*F+G*G)}chargedCylinder.prototype=new cylinder;function gaussianCylinder(a,d,b,c,e,f,h){var k,g,l,p,m,n,B,q,t;this.setX=function(a){B=a;l[12]=B;return this};this.getX=function(){return B};this.setY=function(a){q=a;l[13]=q;return this};this.getY=function(){return q};this.setZ=function(a){t=a;l[14]=t;return this};this.getZ=function(){return t};this.setOrigin=function(a){this.setX(a[0]);this.setY(a[1]);return this.setZ(a[2])};this.getOrigin=function(){return[B,q,t]};this.setRadius=function(a){m=a;return this};this.getRadius=function(){return m};
this.setHeight=function(a){g=a;return this};this.getHeight=function(){return g};this.setTheta=function(a){n=a;return this};this.getTheta=function(){return n};this.setPhi=function(a){p=a;return this};this.getPhi=function(){return p};this.render=function(a,b){this.fullRender(a,b,l,g,m,m,!0)};k=new Color(0.5,0.5,0.5,0.5);g=c;p=f;m=e;n=h;B=a;q=d;t=b;this.setColor(k);l=this.getCylinderModelView(B,q,t,this.getBaseHeight(),this.getBaseRadius(),p,n)}gaussianCylinder.prototype=new cylinder;function chargedSphere(a,d,b,c,e,f,h){var k,g,l,p,m,n,B,q;B=0;k=f;g=k*k;l=g*k;p=h;m=p*p*p;this.setA=function(a){k=a;g=k*k;l=g*k};this.getA=function(){return k};this.setB=function(a){p=a;m=p*p*p};this.getB=function(){return p};this.setNindices=function(a){B=a};this.setVertexRegistry=function(a){q=a};this.getVertexRegistry=function(){return q};this.getStartPoints=function(){var f,g,h,l,m,n,q;n=0<a?1:0>a?-1:0;f=Math.round(d*a*n);l=4*k/Math.sqrt(f);g=0;m=[];for(var x=0;x<f;x++)q=(-1+2*x/(f-1))*k,h=Math.sqrt(k*
k-q*q)+0.2*(p-k),g+=l/h,m.push([Math.cos(g)*h+b,q+c,Math.sin(g)*h+e,n]);return m};this.getField=function(d,f,h){var n,q=[0,0,0],w;d-=b;f-=c;h-=e;n=d*d+f*f+h*h;if(n<=g)return q;w=Math.sqrt(n);n=w>=k&&w<p?a*(w-l/n)/(m-l):a/n;q[0]=n*d/w;q[1]=n*f/w;q[2]=n*h/w;return q};this.getModelView=function(a){"undefined"===typeof a&&(a=1);null==n?(n=new Float32Array(16),n[0]=a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=a,n[11]=0,n[12]=b,n[13]=c,n[14]=e,n[15]=1):(n[0]=a,n[5]=a,n[10]=a);
return n};this.drawFullSurface=function(a,b,c,d,e,f){bindBuffer(a,c,"position",b,3,a.FLOAT,0,0);bindBuffer(a,d,"normal",b,3,a.FLOAT,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e);a.drawElements(a.TRIANGLES,f,a.UNSIGNED_SHORT,0)};this.render=function(b,c){var d,e,f,g;d=this.getIntrinsicRadius();g=this.getVertexBuffers(b,q);0<a?loadUniform4f(b,c,"surfaceColor",0.05,0.05,0.8,0.2):0>a?loadUniform4f(b,c,"surfaceColor",0.8,0.05,0.05,0.2):loadUniform4f(b,c,"surfaceColor",0.5,0.5,0.5,0.2);B=this.getNindices();
b.cullFace(b.FRONT);for(e=p;e>=k;e--)f=e/d,loadUniformMatrix4fv(b,c,"modelViewMatrix",this.getModelView(f)),this.drawFullSurface(b,c,g.vertices,g.normals,g.indices,B);b.cullFace(b.BACK);for(e=k;e<=p;e++)f=e/d,this.drawFullSurface(b,c,g.vertices,g.normals,g.indices,B),loadUniformMatrix4fv(b,c,"modelViewMatrix",this.getModelView(f))}}chargedSphere.prototype=new GeometryEngine.sphere;function chargedPlane(a,d,b,c,e,f,h,k,g,l,p,m,n,B){var q,t,u,y,A,v,w,s,x,D,r,z,C,E,F,G,H,I,J,M,L,K;this.setVertexRegistry=function(a){L=a};this.getVertexRegistry=function(){return L};this.calculateNormal=function(a){var b;b=Array(3);b[0]=(a[4]-a[1])*(a[11]-a[2])-(a[5]-a[2])*(a[10]-a[1]);b[1]=(a[5]-a[2])*(a[9]-a[0])-(a[3]-a[0])*(a[11]-a[2]);b[2]=(a[3]-a[0])*(a[10]-a[1])-(a[4]-a[1])*(a[9]-a[0]);a=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);b[0]/=a;b[1]/=a;b[2]/=a;return b};this.adjustStartPoints=function(a){var b,
c,d,e,f;b=a.length;for(var g=0;g<b;g++)c=a[g],d=c[0],e=c[1],f=c[2],c[0]=H+w*(F*d*A+f*r)+C*(-G*e*v+z*(-F*d*r+f*A)),c[1]=I+w*(G*e*v+z*(F*d*r-f*A))+C*(F*d*A+f*r),c[2]=J+G*e*z+v*(-F*d*r+f*A);return a};this.getStartPoints=function(){var a,b,c,d,e,f,g;b=Math.abs(E*D);e=[];if(0<b)for(a=Math.sqrt(1/b),b=a/Math.abs(F),a/=Math.abs(G),c=!1,d=0<E?1:-1,f=Math.min(-0.5+b/2,0.5),g=Math.min(-0.5+a/2,0.5);!c;)e.push([f,g,0.4,d]),e.push([f,g,-0.4,d]),g+=a,0.5<g?(g=0.5-(g-0.5),f+=b,a=-a):-0.5>g&&(g=-0.5-(g- -0.5),f+=
b,a=-a),c=0.5<f;return this.adjustStartPoints(e)};this.getField=function(a,b,c){var d;d=Array(3);a=(a-y[0])*x[0]+(b-y[1])*x[1]+(c-y[2])*x[2];b=M*E;0==a&&(d[0]=0,d[1]=0,d[2]=0);0<a?(d[0]=b*x[0],d[1]=b*x[1],d[2]=b*x[2]):(d[0]=-b*x[0],d[1]=-b*x[1],d[2]=-b*x[2]);return d};this.translateBoundingBox=function(a){H=(b+g)/2;I=(c+l)/2;J=(e+p)/2;a[0]-=H;a[1]-=I;a[2]-=J;a[3]-=H;a[4]-=I;a[5]-=J;a[6]-=H;a[7]-=I;a[8]-=J;a[9]-=H;a[10]-=I;a[11]-=J;return a};this.zAxisRotation=function(a){var b,d;b=a[3]-a[0];d=a[0]-
a[9];0==b||0==d?(u=0,K=0==b&&0==d?0==a[4]-a[1]?1:2:0==b?1:2):(b=(h-c)/b,d=(l-h)/d,Math.abs(b)<Math.abs(d)?(u=Math.atan(b),K=1):(u=Math.atan(d),K=2));w=Math.cos(u);C=Math.sin(u);for(var e=0;4>e;e++)d=w*a[3*e]-C*a[3*e+1],b=C*a[3*e]+w*a[3*e+1],a[3*e]=d,a[3*e+1]=b;return a};this.xAxisRotation=function(a,b){var c,d;1==b?(c=a[1]-a[10],d=a[2]-a[11]):(c=a[4]-a[1],d=a[5]-a[2]);z=t=0;v=1;if(0!=d&&0!=c){t=Math.atan(d/c);z=Math.sin(t);v=Math.cos(t);for(var e=0;4>e;e++)c=v*a[3*e+1]-z*a[3*e+2],d=z*a[3*e+1]+v*a[3*
e+2],a[3*e+1]=c,a[3*e+2]=d}return a};this.yAxisRotation=function(a,b){var c,d;1==b?(c=a[0]-a[9],d=a[2]-a[11]):(c=a[3]-a[0],d=a[5]-a[2]);r=q=0;A=1;if(0!=d){0!=c?(q=Math.atan(d/c),r=Math.sin(q),A=Math.cos(q)):(q=1.5707963267948966,r=1,A=0);for(var e=0;4>e;e++)c=A*a[3*e]+r*a[3*e+2],d=-r*a[3*e]+A*a[3*e+2],a[3*e]=c,a[3*e+2]=d}return a};this.scaleBoundingbox=function(a,b){1==b?(F=a[0]-a[9],G=a[4]-a[1]):(F=a[3]-a[0],G=a[1]-a[10]);for(var c=0;4>c;c++)0!=F&&(a[3*c]/=F),0!=G&&(a[3*c+1]/=G);return a};this.getModelView=
function(){return s};this.drawFullSurface=function(a,b,c,d,e,f){bindBuffer(a,c,"position",b,3,a.FLOAT,0,0);bindBuffer(a,d,"normal",b,3,a.FLOAT,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e);a.drawElements(a.TRIANGLES,f,a.UNSIGNED_SHORT,0)};this.render=function(a,b){var c,d;c=this.getVertexBuffers(a,L);0<E?loadUniform4f(a,b,"surfaceColor",0.05,0.05,0.8,0.4):0>E?loadUniform4f(a,b,"surfaceColor",0.8,0.05,0.05,0.4):loadUniform4f(a,b,"surfaceColor",0.5,0.5,0.5,0.2);d=this.getNindices();loadUniformMatrix4fv(a,
b,"modelViewMatrix",this.getModelView());a.disable(a.CULL_FACE);this.drawFullSurface(a,b,c.vertices,c.normals,c.indices,d);a.enable(a.CULL_FACE)};M=6.283185307179586;E=a;D=d;y=[b,c,e,f,h,k,g,l,p,m,n,B];a=y.slice(0);x=this.calculateNormal(y);a=this.translateBoundingBox(a);a=this.zAxisRotation(a);a=this.xAxisRotation(a,K);a=this.yAxisRotation(a,K);a=this.scaleBoundingbox(a,K);s=new Float32Array(16);A=Math.cos(-q);v=Math.cos(-t);w=Math.cos(-u);r=Math.sin(-q);z=Math.sin(-t);C=Math.sin(-u);s[0]=F*(A*w-
r*z*C);s[1]=F*(A*C+w*r*z);s[2]=-F*v*r;s[3]=0;s[4]=-G*v*C;s[5]=G*v*w;s[6]=G*z;s[7]=0;s[8]=z*C*A+r*w;s[9]=-(z*A*w-r*C);s[10]=A*v;s[11]=0;s[12]=H;s[13]=I;s[14]=J;s[15]=1}chargedPlane.prototype=new GeometryEngine.square;function fieldRenderer(a,d){var b,c,e,f,h,k,g,l,p,m,n,B,q,t,u,y,A,v,w,s,x,D,r,z,C,E;e=new Charges;k=[];n=[];A="undefined"==typeof d?"./":d;B=!1;z=k;E=new GeometryEngine.VertexRegistry;this.addGaussianSurface=function(a){a.setVertexRegistry(E);n.push(a);return this};this.addChargeDistribution=function(a){a.setVertexRegistry(E);e.addDistribution(a);return this};this.addStartPoint=function(a,b,c,d){k.push([a,b,c,d]);return this};this.addCharge=function(a){e.addCharge(a);return this};this.setCharges=
function(a){e=a;e.setVertexRegistry(E)};this.getContext=function(){return m};this.getCharges=function(){return e};this.createSurfaceProgram=function(a){var b,c;c=compileShader(a,"attribute vec3 normal;attribute vec3 position;uniform   vec3 ambientLighting;uniform   vec3 directionalLighting;uniform   vec3 directionalColor;uniform   mat4 modelViewMatrix;uniform   mat4 globalModelViewMatrix;uniform   mat3 normalMatrix;uniform   mat4 projectionMatrix;varying   vec3 lighting;void main(void){  gl_Position = projectionMatrix * globalModelViewMatrix * modelViewMatrix * vec4(position, 1.0);  vec3  transformedNormal         = normalMatrix * normal;  float directionalLightWeighting = max(dot(transformedNormal, directionalLighting), 0.0);  lighting                        = ambientLighting + directionalColor * directionalLightWeighting;}",
a.VERTEX_SHADER);b=compileShader(a,"precision mediump float;uniform vec4 surfaceColor;varying vec3 lighting;void main(void){  gl_FragColor = vec4(surfaceColor.rgb * lighting, surfaceColor.a);}",a.FRAGMENT_SHADER);return createProgram(a,c,b)};this.createFluxLineProgram=function(a){var b=compileShader(a,"attribute vec3 position;uniform   mat4 modelViewMatrix;uniform   mat4 projectionMatrix;void main(){    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1);}",a.VERTEX_SHADER),c=compileShader(a,
"precision mediump float;void main(){    gl_FragColor = vec4(0.8,0.3,0.3,1);}",a.FRAGMENT_SHADER);return createProgram(a,b,c)};this.createChargeProgram=function(a){var b=compileShader(a,"precision highp float;attribute vec3  position;attribute float charge;varying   float vCharge;uniform   mat4  modelViewMatrix;uniform   mat4  projectionMatrix;void main(){    gl_Position  = projectionMatrix * modelViewMatrix * vec4(position, 1);    gl_PointSize = 16.0;    vCharge      = charge;}",a.VERTEX_SHADER),
c=compileShader(a,"precision lowp float;varying float     vCharge;uniform sampler2D positiveChargeSampler;uniform sampler2D negativeChargeSampler;vec4   textureColor; void main() {   if (vCharge > 0.0)   {       textureColor = texture2D(positiveChargeSampler, gl_PointCoord);   }   else   {       textureColor = texture2D(negativeChargeSampler, gl_PointCoord);   }   if (textureColor.a > 0.5)   {       gl_FragColor = textureColor;   }   else   {       discard;   } }",a.FRAGMENT_SHADER);return createProgram(a,
b,c)};this.makeChargesArray=function(a){var b,c,d,e,f;f=a.getCharges();c=f.length;b=new Float32Array(4*c);for(var g=0;g<c;g++)a=f[g],e=a.getPosition(),d=4*g,b[d]=e[0],b[d+1]=e[1],b[d+2]=e[2],b[d+3]=a.getCharge();return b};this.drawCharges=function(a,b,c,d,e,f,g,h,k,l){a.useProgram(b);loadUniformMatrix4fv(a,b,"modelViewMatrix",c);loadUniformMatrix4fv(a,b,"projectionMatrix",d);bindBuffer(a,e,"position",b,3,a.FLOAT,16,0);bindBuffer(a,e,"charge",b,1,a.FLOAT,16,12);bindTexture(a,b,g,h,"positiveChargeSampler");
bindTexture(a,b,k,l,"negativeChargeSampler");a.drawArrays(a.POINTS,0,f)};this.drawFluxlines=function(a,b,c,d,e,f,g,h){a.useProgram(b);a.lineWidth(1);loadUniformMatrix4fv(a,b,"modelViewMatrix",d);loadUniformMatrix4fv(a,b,"projectionMatrix",c);c=g.length;for(e=0;e<c;e++)d=f[e],bindBuffer(a,g[e],"position",b,3,a.FLOAT,12,0),a.drawArrays(a.LINE_STRIP,0,d[4]),bindBuffer(a,h[e],"position",b,3,a.FLOAT,12,0),a.drawArrays(a.LINES,0,d[5])};this.drawChargeDistributions=function(a,b,c,d,e,f){console.assert(null!=
b);a.useProgram(b);loadUniformMatrix4fv(a,b,"globalModelViewMatrix",d);loadUniformMatrix3fv(a,b,"normalMatrix",e);loadUniformMatrix4fv(a,b,"projectionMatrix",c);loadUniform3f(a,b,"ambientLighting",0.3,0.3,0.3);loadUniform3f(a,b,"directionalLighting",1,1,1);loadUniform3f(a,b,"directionalColor",0.4,0.4,0.4);c=f.length;for(d=0;d<c;d++)f[d].render(a,b)};this.drawGaussianSurfaces=function(a,b,c,d,e,f){console.assert(null!=b);a.useProgram(b);loadUniformMatrix4fv(a,b,"globalModelViewMatrix",d);loadUniformMatrix3fv(a,
b,"normalMatrix",e);loadUniformMatrix4fv(a,b,"projectionMatrix",c);loadUniform4f(a,b,"surfaceColor",0.5,0.5,0.5,0.5);loadUniform3f(a,b,"ambientLighting",0.3,0.3,0.3);loadUniform3f(a,b,"directionalLighting",1,1,1);loadUniform3f(a,b,"directionalColor",0.4,0.4,0.4);c=f.length;for(d=0;d<c;d++)f[d].render(a,b)};this.setModelViewMatrix=function(a){u=a;y=extractRotationPart(u,y)};this.getModelViewMatrix=function(){return u};this.render=function(){B&&!m.isContextLost()&&(m.clear(m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT),
this.drawCharges(m,c,u,D,b,e.getNCharges(),x,s,w,v),this.drawFluxlines(m,p,D,u,e,z,l,g),0<n.length||0<e.getNDistributions())&&(m.enable(m.BLEND),m.enable(m.CULL_FACE),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA),0<e.getNDistributions()&&this.drawChargeDistributions(m,C,D,u,y,e.getDistributions()),m.disable(m.DEPTH_TEST),0<n.length&&this.drawGaussianSurfaces(m,C,D,u,y,n),m.enable(m.DEPTH_TEST),m.disable(m.BLEND),m.disable(m.CULL_FACE))};this.zoomBy=function(a){r+=a;15>r&&(r=15);D=generateOrthographicMatrix(r,
r,-r,r);this.render()};this.allocateStorage=function(){window.webkitStorageInfo.requestQuota(PERSISTENT,2147483648,function(a){console.log("Got storage",a);window.webkitRequestFileSystem(PERSISTENT,a,function(a){window.fs=a;console.log("Got filesystem")})},function(a){console.log("Storage error",a)})};this.capture=function(a){var b=Math.random(),c=a.toDataURL("image/png").slice(22);window.fs.root.getFile(b,{create:!0},function(a){a.createWriter(function(a){for(var b=atob(c),d=new Uint8Array(b.length),
e=0;e<b.length;++e)d[e]=b.charCodeAt(e);b=new Blob([d],{});a.seek(0);a.write(b);console.log("Writing file",frames,b.size)})},function(){console.log("File error",arguments)})};this.initialRender=function(){var a,d,h;D=generateOrthographicMatrix(r,r,-r,r);c=this.createChargeProgram(m);f=this.makeChargesArray(e);b=createBuffer(m,f);p=this.createFluxLineProgram(m);l=[];g=[];z=k;a=e.getDistributions();h=a.length;for(var q=0;q<h;q++)d=a[q].getStartPoints(),z=z.concat(d);new Float32Array(3*t);d=z.length;
a=new fluxLine(e);a.setMaxPoints(5E3);a.setDs(0.3);a.setArrowSpacing(50);a.setArrowSize(3);for(q=0;q<d;q++)h=z[q],a.setStartX(h[0]),a.setStartY(h[1]),a.setStartZ(h[2]),a.setSign(h[3]),a.trace(),l[q]=createBuffer(m,a.getPoints()),h[4]=a.getNpoints(),g[q]=createBuffer(m,a.getArrows()),h[5]=a.getNarrows();if(0<n.length||0<e.getNDistributions())C=this.createSurfaceProgram(m);B=!0;this.render()};this.start=function(){q.countDown()};this.initializeContext=function(a){if(m=getGLContext(a))v=0,w=loadTexture(m,
A+"images/negativeCharge.png",v,q.countDown),s=1,x=loadTexture(m,A+"images/positiveCharge.png",s,q.countDown);return m};h=new GLContextEventHandler(a,this);a.addEventListener("webglcontextlost",h.contextLost.bind(h),!1);a.addEventListener("webglcontextrestored",h.contextRestored.bind(h),!1);q=new countdownLatch(3,this.initialRender.bind(this));m=this.initializeContext(a);u=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);y=new Float32Array([1,0,0,0,1,0,0,0,1]);t=5E3;r=150;h=new motionEventHandler(this);
a.addEventListener("mousewheel",h.handleMouseWheel.bind(h),!1);a.addEventListener("mousedown",h.handleMouseDown.bind(h),!1);document.addEventListener("mouseup",h.handleMouseUp.bind(h),!1);document.addEventListener("mousemove",h.handleMouseMove.bind(h),!1);a.addEventListener("touchstart",h.handleTouchStart.bind(h),!1);a.addEventListener("touchmove",h.handleTouchMove.bind(h),!1);a.addEventListener("touchend",h.handleTouchEnd.bind(h),!1)};
